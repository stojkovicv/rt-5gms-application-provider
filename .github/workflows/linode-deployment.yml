name: linode-deployment

on:
    workflow_call:
        inputs:
            envname:
                required: true
                type: string
            web_server_path:
                required: true
                type: string
            port:
                required: true
                type: string
        secrets:
            host:
                required: true
            user:
                required: true
            private_key:
                required: true

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Set up SSH connection
              uses: webfactory/ssh-agent@v0.5.3
              with:
                ssh-private-key: ${{secrets.private_key}}

            - name: List added SSH keys (for debugging)
              run: ssh-add -l

            - name: Deploy to Linode instance
              env:
                LINODE_IP: ${{secrets.host}}
                USER: ${{secrets.user}}
                WEB_SERVER_PATH: ${{inputs.web_server_path}}
                ENV_NAME: ${{inputs.envname}}
                PORT: ${{inputs.port}}
              run: |
                echo "Starting deployment for ${ENV_NAME} environment on the port ${PORT}"

                ssh -v -o StrictHostKeyChecking=no $USER@$LINODE_IP << 'EOF'
                  set -e
                  echo "Connected to Linode server"
                  echo "Deploying for ${ENV_NAME} branch"
                  cd $WEB_SERVER_PATH
                  git pull origin ${ENV_NAME} || { echo 'Git pull for ${ENV_NAME} failed'; exit 1; }
                  echo "Successfully updated ${ENV_NAME} code"
                  pkill -f "uvicorn.*${PORT}" || echo "No process to kill on port ${PORT}"
                  echo "Clearing port ${PORT}"
                  nohup uvicorn server:app --host 127.0.0.1 --port ${PORT} > ${WEB_SERVER_PATH}/nohup.out 2>&1 &
                  echo "Activated FastAPI server for ${ENV_NAME} environment on port ${PORT}"

                  echo "Deployment completed."
                EOF
